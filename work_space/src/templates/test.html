{% extends "base.html" %}
{% load static %}
{% block header %}
<link rel="stylesheet" href="{% static 'css/test.css' %}" />
{% endblock %}
{% block content %}
{% include "header.html" %}
<div class="boxscore">
  <p class="score">Score: {{ score }}</p>
</div>

<div class="content">
  <img class="test" src="{% static 'img/test.png' %}">

  <div class="q">
    <button class="result" type="submit">結果の表示</button>
    <form id="answer-form" method="post">
      {% csrf_token %}

      {% for problem, choices in problem_choices %}
      <h2>{{ problem.problem_statement }}</h2>

      <div>
        <!-- Add a hidden input field for the problem ID -->
        <input type="hidden" name="problem_id_{{ forloop.counter }}" value="{{ problem.problem_id }}">
        {% for choice in choices %}
        <div class="options">
          <input type="radio" name="user_answer_{{ forloop.parentloop.counter }}"
            id="choice_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" value="{{ choice.choice }}">
          <label for="choice_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">{{ choice.choice }}</label>
        </div>

        {% endfor %}
  
      </div>
      {% endfor %}
      <button class="ansbtn" type="submit">回答</button>
    </form>
    <form method="post">
      {% csrf_token %}
      <input class="recreatebtn" type="submit" name="regenerate" value="再生成">
    </form>
  </div>
</div>
<img id="footer" src="{% static 'img/chalk_rail.png' %}">

<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-contents">
    <span class="close">&times;</span>
    <img class="test" src="{% static 'img/score.png' %}">
    <div id="q">1Q</div>
    <div id="q">2Q</div>
    <div id="q">3Q</div>
    {% for problem, choices in problem_choices %}
    {% if problem.is_correct == True %}
    <p id="re" style="color: green;">正解</p>
    {% elif problem.is_correct == False %}
    <p id="re" style="color: red;">不正解</p>
    {% endif %}
    {% endfor %}
  </div>
</div>
<script>
  // Get the modal
  var modal = document.getElementById("myModal");

  // Get the button that opens the modal
  var btn = document.querySelector(".result");

  // Get the <span> element that closes the modal
  var span = document.getElementsByClassName("close")[0];

  // When the user clicks the button, open the modal
  btn.addEventListener("click", function (event) {
    event.preventDefault(); // Prevent the default form submission
    var form = document.getElementById("answer-form");
    var formData = new FormData(form);

    // Perform the form submission using AJAX
    var xhr = new XMLHttpRequest();
    xhr.open(form.method, form.action, true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && xhr.status === 200) {
        // Form submission is successful, open the modal
        modal.style.display = "block";

        // Save the modal state in local storage
        localStorage.setItem("modalDisplayed", "true");
      }
    };
    xhr.send(formData);
  });

  // When the user clicks on <span> (x), close the modal
  span.addEventListener("click", function () {
    modal.style.display = "none";
  });

  // When the user clicks anywhere outside of the modal, close it
  window.addEventListener("click", function (event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  });

  // Check if the modal should be displayed from local storage
  var modalDisplayed = localStorage.getItem("modalDisplayed");
  if (modalDisplayed === "true") {
    modal.style.display = "block";
  }

  // Clear the modal state from local storage after displaying the modal
  localStorage.removeItem("modalDisplayed");
</script>
{% endblock %}
